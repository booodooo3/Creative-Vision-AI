// ุงุณุชูุฑุงุฏ ุงูููุชุจุงุช ุงููุทููุจุฉ
// Import required libraries
const express = require('express');
const axios = require('axios');
const cors = require('cors');
const path = require('path'); // ุงุณุชูุฑุงุฏ ููุชุจุฉ path ููุชุนุงูู ูุน ุงููุณุงุฑุงุช
require('dotenv').config(); // ูุงุณุชุฎุฏุงู ูุชุบูุฑุงุช ุงูุจูุฆุฉ ูู ููู .env

// ุฅุนุฏุงุฏ ุชุทุจูู Express
// Initialize the Express app
const app = express();
// ุงุณุชุฎุฏู ูููุฐ ุงูุจูุฆุฉ ุฃู 3000 ููููุฐ ุงูุชุฑุงุถู
// Use the environment's port or 3000 as a default
const port = process.env.PORT || 3000;

// --- Middleware ---
app.use(cors());
// ุฒูุงุฏุฉ ุญุฏ ุญุฌู ุงูุทูุจ ูุงุณุชูุนุงุจ ุจูุงูุงุช ุงูุตูุฑ (base64)
// Increase the request body size limit to accommodate image data (base64)
app.use(express.json({ limit: '10mb' }));

// --- ุชูุฏูู ุงููุงุฌูุฉ ุงูุฃูุงููุฉ (ูููุงุช ุซุงุจุชุฉ) ---
// ูู ุจุชูุฏูู ุงููููุงุช ุงูุซุงุจุชุฉ ูู ูุฌูุฏ "public"
// Serve static files from the "public" directory
app.use(express.static(path.join(__dirname, 'public')));


// --- ูุชุบูุฑุงุช ุงูุจูุฆุฉ ---
const API_KEY = process.env.GOOGLE_AI_API_KEY;
if (!API_KEY) {
    console.error("ุฎุทุฃ: ูุชุบูุฑ ุงูุจูุฆุฉ GOOGLE_AI_API_KEY ุบูุฑ ููุฌูุฏ.");
}


// --- ููุงุท ุงูููุงูุฉ (API Endpoints) ---

/**
 * ููุทุฉ ููุงูุฉ ูุฅูุดุงุก ุงูุตูุฑ (Text-to-Image)
 */
app.post('/api/generate-image', async (req, res) => {
    const { prompt } = req.body;
    if (!prompt) {
        return res.status(400).json({ error: 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ูุตู ูุตู (prompt).' });
    }
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${API_KEY}`;
    const payload = { instances: [{ prompt }], parameters: { "sampleCount": 1 } };
    try {
        const response = await axios.post(apiUrl, payload);
        res.json(response.data);
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุฅูุดุงุก ุงูุตูุฑุฉ:', error.response ? error.response.data : error.message);
        res.status(error.response?.status || 500).json({ error: 'ูุดู ุฅูุดุงุก ุงูุตูุฑุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.' });
    }
});

/**
 * ููุทุฉ ููุงูุฉ ููุจุญุซ ุงููุงูููู
 */
app.post('/api/legal-search', async (req, res) => {
    const { query } = req.body;
    if (!query) {
        return res.status(400).json({ error: 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณุชุนูุงู ุงูุจุญุซ.' });
    }
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
    const systemPrompt = "You are a professional legal assistant. Your task is to find official laws and legal articles based on the user's query. Use the search tool to find the most accurate and up-to-date information from official government or legal sources. Provide a clear summary of the law, and you MUST cite your sources.";
    const payload = {
        contents: [{ parts: [{ text: query }] }],
        tools: [{ "google_search": {} }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
    };
    try {
        const response = await axios.post(apiUrl, payload);
        res.json(response.data);
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุงูุจุญุซ ุงููุงูููู:', error.response ? error.response.data : error.message);
        res.status(error.response?.status || 500).json({ error: 'ูุดู ุงูุจุญุซ ุงููุงูููู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.' });
    }
});

/**
 * ููุทุฉ ููุงูุฉ ูุชุฑุฌูุฉ ุงููุตูุต (ุฌุฏูุฏ)
 */
app.post('/api/translate', async (req, res) => {
    const { text, source, target } = req.body;
    if (!text) {
        return res.status(400).json({ error: 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ูุต ููุชุฑุฌูุฉ.' });
    }
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
    const systemPrompt = `You are an expert multilingual translator. Translate the user's text accurately from the source language to the target language. Provide only the translated text as the output, with no additional commentary or explanations.`;
    const userPrompt = `Translate the following text from ${source} to ${target}:\n\n"${text}"`;
    const payload = { contents: [{ parts: [{ text: userPrompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
    try {
        const response = await axios.post(apiUrl, payload);
        res.json(response.data);
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุงูุชุฑุฌูุฉ:', error.response ? error.response.data : error.message);
        res.status(error.response?.status || 500).json({ error: 'ูุดูุช ุนูููุฉ ุงูุชุฑุฌูุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.' });
    }
});

/**
 * ููุทุฉ ููุงูุฉ ูุชุนุฏูู ุงูุตูุฑ (ุฌุฏูุฏ)
 */
app.post('/api/edit-image', async (req, res) => {
    const { prompt, base64Data, mimeType } = req.body;
    if (!prompt || !base64Data || !mimeType) {
        return res.status(400).json({ error: 'ุจูุงูุงุช ุงูุตูุฑุฉ ุฃู ูุตู ุงูุชุนุฏูู ุบูุฑ ููุชููุฉ.' });
    }
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${API_KEY}`;
    const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType, data: base64Data } }] }], generationConfig: { responseModalities: ['IMAGE'] } };
    try {
        const response = await axios.post(apiUrl, payload);
        res.json(response.data);
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุชุนุฏูู ุงูุตูุฑุฉ:', error.response ? error.response.data : error.message);
        res.status(error.response?.status || 500).json({ error: 'ูุดู ุชุนุฏูู ุงูุตูุฑุฉ. ูุฏ ูููู ุจุณุจุจ ููุงุชุฑ ุงูุฃูุงู.' });
    }
});

/**
 * ููุทุฉ ููุงูุฉ ูุฏูุฌ ุงูุตูุฑ (ุฌุฏูุฏ)
 */
app.post('/api/merge-images', async (req, res) => {
    const { prompt, base64Data1, mimeType1, base64Data2, mimeType2 } = req.body;
    if (!base64Data1 || !mimeType1 || !base64Data2 || !mimeType2) {
        return res.status(400).json({ error: 'ูุฌุจ ุฑูุน ุงูุตูุฑุชูู ูุฅุชูุงู ุนูููุฉ ุงูุฏูุฌ.' });
    }
    const userPrompt = prompt.trim() || "Merge these two images together creatively.";
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${API_KEY}`;
    const payload = { 
        contents: [{ parts: [
            { text: userPrompt }, 
            { inlineData: { mimeType: mimeType1, data: base64Data1 } }, 
            { inlineData: { mimeType: mimeType2, data: base64Data2 } }
        ] }], 
        generationConfig: { responseModalities: ['IMAGE'] } 
    };
    try {
        const response = await axios.post(apiUrl, payload);
        res.json(response.data);
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุฏูุฌ ุงูุตูุฑ:', error.response ? error.response.data : error.message);
        res.status(error.response?.status || 500).json({ error: 'ูุดู ุฏูุฌ ุงูุตูุฑ. ูุฏ ูููู ุจุณุจุจ ููุงุชุฑ ุงูุฃูุงู.' });
    }
});


// --- ุชูุฏูู ููู index.html ููุทูุจุงุช ุงูุฃุฎุฑู ---
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'index.html'));
});


// --- ุชุดุบูู ุงูุณูุฑูุฑ ---
app.listen(port, () => {
    console.log(`๐ ุงูุณูุฑูุฑ ูุนูู ุงูุขู ุนูู http://localhost:${port}`);
});

