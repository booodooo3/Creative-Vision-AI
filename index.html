<!DOCTYPE html>
<!-- lang and dir will be set by JavaScript -->
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creative Vision AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF and JSZip for PDF/ZIP creation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- PayPal SDK with Google Pay enabled -->
    <script src="https://www.paypal.com/sdk/js?client-id=Afz7LD4ih71vPV0lFyTsmspbrBD8Tew27tKh1nkzIGQ5tBbQjCTXqTZohewqLiRXjJrl8yq0XLoP0NVq&currency=USD&components=buttons,googlepay" defer></script>
    
    <!-- Fonts for both languages -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Default font will be set by JS */
        body {
            font-family: 'Tajawal', sans-serif;
        }
        .tab-btn {
            transition: all 0.3s ease-in-out;
        }
        .tab-btn:not(.tab-active) {
            opacity: 0.6;
        }
        .tab-btn:hover:not(.tab-active) {
            opacity: 1;
        }
        .tab-active {
            border-color: #3b82f6;
            color: #ffffff;
            background-color: #1e293b;
            opacity: 1;
            box-shadow: 0 2px 15px -5px #3b82f6;
            text-shadow: 0 0 5px #3b82f6;
        }
        .pulsing-loader {
            border: 4px solid #3b82f6;
            border-right-color: transparent;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #error-message-box {
            display: none;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 90%;
            max-width: 500px;
        }
        .image-preview-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            background-color: #334155;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        #edit-image-preview-container {
             transform: rotate(-2.5deg); /* Angled preview */
        }
        #edit-image-preview-container:hover {
            transform: rotate(0deg); /* Straighten on hover */
        }
        .preview-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .result-text-container {
            white-space: pre-wrap; /* Allows text to wrap and respects newlines */
            text-align: right;
            direction: rtl;
        }
        html[lang="en"] .result-text-container {
            text-align: left;
            direction: ltr;
        }
        /* Added to prevent text selection in article box */
        #text-result-container, .no-screenshot {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .lang-active {
            background-color: #3b82f6;
            color: white;
        }
        .watermark-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
            pointer-events: none;
            opacity: 0.1;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='250' height='150'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='20' font-family='Tajawal, sans-serif' fill='%23FFF' transform='rotate(-30, 125, 75)'%3ECreative Vision AI%3C/text%3E%3C/svg%3E");
            background-repeat: repeat;
        }
        /* CSS to prevent printing */
        @media print {
            body * {
                visibility: hidden;
            }
            body::before {
                content: "Printing and content capture are disabled on this page.";
                visibility: visible;
                display: block;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 20px;
                color: #000;
                text-align: center;
            }
        }
    </style>
</head>
<body class="bg-slate-900 text-gray-200 flex flex-col items-center justify-center min-h-screen p-4">

    <!-- Language Switcher Moved Here -->
    <div class="w-full max-w-4xl flex justify-start rtl:justify-end mb-2">
        <div id="lang-switcher-container" class="flex space-x-2 rtl:space-x-reverse">
            <button id="lang-btn-en" class="lang-btn bg-slate-700 hover:bg-slate-600 text-white font-bold w-10 h-10 rounded-lg flex items-center justify-center transition duration-300 text-lg">E</button>
            <button id="lang-btn-ar" class="lang-btn bg-slate-700 hover:bg-slate-600 text-white font-bold w-10 h-10 rounded-lg flex items-center justify-center transition duration-300 text-lg">A</button>
        </div>
    </div>

    <div id="main-content-wrapper" class="w-full max-w-4xl bg-slate-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
        <!-- Header -->
        <header class="text-center">
            <img src="https://intrigued-isabelle-4i.zipwp.link/wp-content/uploads/2025/09/Opera-Snapshot_2025-09-05_220207_index.html.png" alt="Creative Vision AI Title" class="mx-auto w-full max-w-md rounded-lg">
        </header>

        <!-- Error Message Box -->
        <div id="error-message-box" class="p-4 mb-4 text-sm text-red-300 bg-red-900/50 rounded-lg border border-red-800/50 flex items-center gap-3" role="alert">
            <svg class="w-5 h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
            <div>
                <span id="error-title" class="font-bold" data-key="errorTitleDefault"></span> 
                <span id="error-text"></span>
            </div>
        </div>

        <!-- Tabs -->
        <div class="border-b border-slate-700">
            <nav class="-mb-px flex space-x-4 rtl:space-x-reverse overflow-x-auto pb-px" aria-label="Tabs">
                <button id="tab-text" data-key="tabText" class="tab-btn tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">نص إلى صورة</button>
                <button id="tab-faceswap" data-key="tabFaceSwap" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500">تركيب الوجوه</button>
                <button id="tab-aiedit" data-key="tabAiEdit" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500">تعديل الصور</button>
                <button id="tab-translate" data-key="tabTranslate" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500">ترجمة النصوص</button>
                <button id="tab-merge" data-key="tabMerge" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500">دمج الصور</button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div id="tab-content-text" class="tab-content">
            <textarea id="text-prompt" data-key-placeholder="textPlaceholder" class="w-full bg-slate-700 text-gray-200 rounded-lg p-4 h-32 resize-none focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="مثال: رائد فضاء يركب حصانًا على المريخ، بأسلوب سينمائي..."></textarea>
            <button id="generate-btn-text" data-key="generateBtn" class="generate-btn mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">إنشاء صورة</button>
        </div>

        <div id="tab-content-faceswap" class="tab-content hidden space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Source Face Upload -->
                <div class="space-y-2">
                    <label for="faceswap-image-upload-source" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 text-center cursor-pointer block">
                        <span data-key="uploadSourceFace"></span>
                    </label>
                    <input id="faceswap-image-upload-source" type="file" class="hidden" accept="image/*" />
                    <div class="image-preview-container">
                         <div class="watermark-overlay"></div>
                         <div id="faceswap-image-placeholder-source" class="text-center text-slate-400 p-4">
                            <svg class="w-12 h-12 mx-auto text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                         </div>
                         <img id="faceswap-image-preview-source" src="#" alt="Source face for swapping" class="preview-image hidden">
                         <button id="cancel-preview-btn-faceswap-source" class="absolute top-2 right-2 rtl:right-auto rtl:left-2 z-20 bg-slate-800/50 hover:bg-slate-700/70 rounded-full p-1 hidden cursor-pointer">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                         </button>
                    </div>
                </div>
                 <!-- Target Image Upload -->
                <div class="space-y-2">
                    <label for="faceswap-image-upload-target" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 text-center cursor-pointer block">
                        <span data-key="uploadTargetImage"></span>
                    </label>
                    <input id="faceswap-image-upload-target" type="file" class="hidden" accept="image/*" />
                     <div class="image-preview-container">
                         <div class="watermark-overlay"></div>
                         <div id="faceswap-image-placeholder-target" class="text-center text-slate-400 p-4">
                            <svg class="w-12 h-12 mx-auto text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                         </div>
                         <img id="faceswap-image-preview-target" src="#" alt="Target image for swapping" class="preview-image hidden">
                         <button id="cancel-preview-btn-faceswap-target" class="absolute top-2 right-2 rtl:right-auto rtl:left-2 z-20 bg-slate-800/50 hover:bg-slate-700/70 rounded-full p-1 hidden cursor-pointer">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                         </button>
                    </div>
                </div>
            </div>
            <p class="text-xs text-center text-slate-400 px-4" data-key="faceSwapInstructions"></p>
            <button id="generate-btn-faceswap" data-key="faceSwapBtn" class="generate-btn mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 disabled:bg-slate-600 disabled:cursor-not-allowed" disabled>بدء التركيب</button>
        </div>

        <div id="tab-content-aiedit" class="tab-content hidden space-y-4">
             <label for="edit-image-upload" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 text-center cursor-pointer block">
                <span data-key="uploadForEditing"></span>
            </label>
            <input id="edit-image-upload" type="file" class="hidden" accept="image/*" />
            
            <div id="edit-image-preview-container" class="image-preview-container">
                 <div class="watermark-overlay"></div>
                 <div id="edit-image-placeholder" class="text-center text-slate-400 p-4">
                    <svg class="w-16 h-16 mx-auto text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <p class="mt-2 font-semibold" data-key="imagePreviewPlaceholder">معاينة الصورة</p>
                 </div>
                 <img id="edit-image-preview" src="#" alt="Image preview for editing" class="preview-image hidden">
                 <button id="cancel-preview-btn" class="absolute top-2 right-2 rtl:right-auto rtl:left-2 z-20 bg-slate-800/50 hover:bg-slate-700/70 rounded-full p-1 hidden cursor-pointer">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                 </button>
                 <div class="absolute top-0 left-0 w-full h-full z-10"></div>
            </div>

            <textarea id="edit-prompt" data-key-placeholder="editPlaceholder" class="w-full bg-slate-700 text-gray-200 rounded-lg p-4 h-24 resize-none focus:ring-2 focus:ring-blue-500 focus:outline-none disabled:cursor-not-allowed disabled:bg-slate-600" placeholder="مثال: تغيير لون الشعر إلى أشقر، إضافة قبعة..." disabled></textarea>
            <button id="generate-btn-aiedit" data-key="editBtn" class="generate-btn w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 disabled:bg-slate-600 disabled:cursor-not-allowed" disabled>تطبيق التعديلات</button>
        </div>
        
        <div id="tab-content-translate" class="tab-content hidden space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="source-lang" class="block text-sm font-medium text-gray-400 mb-2" data-key="sourceLangLabel">من لغة</label>
                    <select id="source-lang" class="w-full bg-slate-700 text-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <option value="Arabic">العربية</option>
                        <option value="English">English</option>
                        <option value="Hebrew">עברית</option>
                        <option value="Aramaic">Aramaic</option>
                        <option value="Syriac">Syriac</option>
                    </select>
                </div>
                <div>
                    <label for="target-lang" class="block text-sm font-medium text-gray-400 mb-2" data-key="targetLangLabel">إلى لغة</label>
                    <select id="target-lang" class="w-full bg-slate-700 text-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <option value="English" selected>English</option>
                        <option value="Arabic">العربية</option>
                        <option value="Hebrew">עברית</option>
                        <option value="Aramaic">Aramaic</option>
                        <option value="Syriac">Syriac</option>
                    </select>
                </div>
            </div>
            <textarea id="translate-input" data-key-placeholder="translatePlaceholder" class="w-full bg-slate-700 text-gray-200 rounded-lg p-4 h-32 resize-none focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="اكتب النص الذي تريد ترجمته هنا..."></textarea>
            <button id="generate-btn-translate" data-key="translateBtn" class="generate-btn w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">ترجمة</button>
        </div>
        
        <div id="tab-content-merge" class="tab-content hidden space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Image 1 Upload -->
                <div class="space-y-2">
                    <label for="merge-image-upload-1" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 text-center cursor-pointer block">
                        <span data-key="uploadForMerge1"></span>
                    </label>
                    <input id="merge-image-upload-1" type="file" class="hidden" accept="image/*" />
                    <div id="merge-image-preview-container-1" class="image-preview-container">
                         <div class="watermark-overlay"></div>
                         <div id="merge-image-placeholder-1" class="text-center text-slate-400 p-4">
                            <svg class="w-12 h-12 mx-auto text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                         </div>
                         <img id="merge-image-preview-1" src="#" alt="Image 1 for merging" class="preview-image hidden">
                         <button id="cancel-preview-btn-merge-1" class="absolute top-2 right-2 rtl:right-auto rtl:left-2 z-20 bg-slate-800/50 hover:bg-slate-700/70 rounded-full p-1 hidden cursor-pointer">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                         </button>
                    </div>
                </div>
                 <!-- Image 2 Upload -->
                <div class="space-y-2">
                    <label for="merge-image-upload-2" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 text-center cursor-pointer block">
                        <span data-key="uploadForMerge2"></span>
                    </label>
                    <input id="merge-image-upload-2" type="file" class="hidden" accept="image/*" />
                     <div id="merge-image-preview-container-2" class="image-preview-container">
                         <div class="watermark-overlay"></div>
                         <div id="merge-image-placeholder-2" class="text-center text-slate-400 p-4">
                            <svg class="w-12 h-12 mx-auto text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                         </div>
                         <img id="merge-image-preview-2" src="#" alt="Image 2 for merging" class="preview-image hidden">
                         <button id="cancel-preview-btn-merge-2" class="absolute top-2 right-2 rtl:right-auto rtl:left-2 z-20 bg-slate-800/50 hover:bg-slate-700/70 rounded-full p-1 hidden cursor-pointer">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                         </button>
                    </div>
                </div>
            </div>
            <textarea id="merge-prompt" data-key-placeholder="mergePlaceholder" class="w-full bg-slate-700 text-gray-200 rounded-lg p-4 h-24 resize-none focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="وصف اختياري: ادمج الصورتين مع التركيز على..."></textarea>
            <button id="generate-btn-merge" data-key="mergeBtn" class="generate-btn w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 disabled:bg-slate-600 disabled:cursor-not-allowed" disabled>دمج الصورتين</button>
        </div>


        <!-- Result Section -->
        <div id="result-section" class="bg-slate-900 rounded-lg p-4 min-h-[300px] flex flex-col items-center justify-center space-y-4 hidden">
            <!-- Loader -->
            <div id="loader" class="text-center">
                <div class="pulsing-loader mx-auto"></div>
                <p data-key="loaderText" class="mt-4 text-gray-400"></p>
            </div>
            <!-- Image Result -->
            <div id="image-result-container" class="w-full max-w-lg hidden relative">
                <button id="cancel-generation-btn" class="absolute top-2 right-2 rtl:right-auto rtl:left-2 z-20 bg-slate-800/50 hover:bg-slate-700/70 rounded-full p-1 cursor-pointer">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <div class="watermark-overlay"></div>
                <img id="generated-image" class="w-full rounded-lg" alt="">
                <div class="absolute top-0 left-0 w-full h-full z-10"></div>
            </div>
            <!-- Article/Translation Result -->
            <div id="text-result-container" class="w-full max-w-3xl bg-slate-800 p-4 rounded-lg h-96 overflow-y-auto hidden relative">
                <button id="cancel-article-btn" class="absolute top-2 right-2 rtl:right-auto rtl:left-2 z-20 bg-slate-900/50 hover:bg-slate-700/70 rounded-full p-2 cursor-pointer">
                   <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <button id="download-translation-btn" data-key-title="downloadTranslation" class="absolute top-2 right-12 rtl:right-auto rtl:left-12 z-20 bg-slate-900/50 hover:bg-slate-700/70 rounded-full p-2 cursor-pointer hidden">
                   <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                </button>
                <div id="article-content" class="result-text-container"></div>
            </div>
            <!-- Payment & Download Section -->
            <div id="payment-section" class="text-center hidden w-full max-w-md space-y-3">
                 <div id="payment-message" class="hidden p-3 text-sm text-green-400 bg-green-800/50 rounded-lg" role="alert">
                    <span data-key="paymentSuccess" class="font-medium"></span>
                </div>
                <p id="payment-instruction" data-key="paymentInstructionText" class="text-sm text-gray-300"></p>
                <div id="paypal-button-container"></div>
                <a id="download-btn" href="#" download="ai_generated_content.zip" class="hidden w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 text-center inline-block opacity-50 cursor-not-allowed">
                    <span></span>
                </a>
            </div>
        </div>
    </div>

    <footer class="text-center py-4">
        <p data-key="copyright" class="text-xs text-slate-500"></p>
        <div class="mt-2">
            <a href="https://www.instagram.com/boood0003" target="_blank" rel="noopener noreferrer" class="text-xs text-slate-500 hover:text-slate-400 transition-colors">
                https://www.instagram.com/boood0003
            </a>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { jsPDF } = window.jspdf;
            const JSZip = window.JSZip;

            // --- IMPORTANT: API Key ---
            const apiKey = "AIzaSyDHG1ON1VXbUWfoSMn9tBZq2ZAIMMdkuS4";
            

            // --- I18N (Internationalization) ---
            const translations = {
                en: {
                    tabText: 'Text to Image',
                    tabFaceSwap: 'Face Swap',
                    tabAiEdit: 'AI Image Editing',
                    tabTranslate: 'Text Translation',
                    tabMerge: 'Image Merge',
                    textPlaceholder: 'Example: An astronaut riding a horse on Mars, cinematic style...',
                    generateBtn: 'Generate Image',
                    uploadSourceFace: 'Upload Face (Source)',
                    uploadTargetImage: 'Upload Image (Target)',
                    faceSwapBtn: 'Execute Photorealistic Swap',
                    faceSwapInstructions: 'For best results, use clear, front-facing photos with similar lighting conditions.',
                    uploadForEditing: 'Upload an Image to Start Editing',
                    editPlaceholder: 'e.g., change hair color to blonde, add a hat...',
                    editBtn: 'Apply Edits',
                    sourceLangLabel: 'From Language',
                    targetLangLabel: 'To Language',
                    translatePlaceholder: 'Enter text to translate here...',
                    translateBtn: 'Translate',
                    uploadForMerge1: 'Upload Image 1',
                    uploadForMerge2: 'Upload Image 2',
                    mergePlaceholder: 'Optional: Describe how to merge the images...',
                    mergeBtn: 'Merge Images',
                    downloadTranslation: 'Download translation (payment required)',
                    imagePreviewPlaceholder: 'Image Preview',
                    loaderText: 'The AI is creating your content... This might take a moment.',
                    generatedImageAlt: 'AI Generated Image',
                    paymentSuccess: 'Payment successful! You can now download your file.',
                    paymentInstructionText: 'To unlock the download, please complete the $1.00 payment below.',
                    downloadBtnImage: 'Download Image',
                    downloadBtnZip: 'Download ZIP File',
                    errorTitleDefault: 'Operation Failed!',
                    errorInputTitle: 'Input Error',
                    errorInputText: 'Please enter a text prompt to generate the image.',
                    errorInputFaceSwap: 'Please upload both a source face and a target image.',
                    errorInputEdit: 'Please upload an image and provide an edit instruction.',
                    errorInputTranslate: 'Please enter text to translate.',
                    errorInputMerge: 'Please upload both images to merge them.',
                    errorPaymentTitle: 'Payment Required',
                    errorPaymentText: 'Please complete the payment process to enable the download link.',
                    errorApiLimit: 'You have reached the request limit. Please try again later.',
                    errorApiGeneric: 'An error occurred: {message}',
                    errorNoImage: 'Valid image data was not received from the API.',
                    errorNoText: 'Valid text was not received from the API. The response may have been blocked.',
                    errorApiKey: 'API Key is missing or invalid. Please check your key in the script.',
                    errorScreenshotDisabled: "Screenshots are disabled for this content.",
                    copyright: `Copyright © ${new Date().getFullYear()} Creative Vision AI. All Rights Reserved.`,
                },
                ar: {
                    tabText: 'نص إلى صورة',
                    tabFaceSwap: 'تركيب الوجوه',
                    tabAiEdit: 'تعديل الصور',
                    tabTranslate: 'ترجمة النصوص',
                    tabMerge: 'دمج الصور',
                    textPlaceholder: 'مثال: رائد فضاء يركب حصانًا على المريخ، بأسلوب سينمائي...',
                    generateBtn: 'إنشاء صورة',
                    uploadSourceFace: 'ارفع صورة الوجه (المصدر)',
                    uploadTargetImage: 'ارفع الصورة (الهدف)',
                    faceSwapBtn: 'تنفيذ تركيب احترافي',
                    faceSwapInstructions: 'لأفضل النتائج، استخدم صورًا واضحة للوجه وبإضاءة متشابهة.',
                    uploadForEditing: 'ارفع صورة لبدء التعديل',
                    editPlaceholder: 'مثال: تغيير لون الشعر إلى أشقر، إضافة قبعة...',
                    editBtn: 'تطبيق التعديلات',
                    sourceLangLabel: 'من لغة',
                    targetLangLabel: 'إلى لغة',
                    translatePlaceholder: 'اكتب النص الذي تريد ترجمته هنا...',
                    translateBtn: 'ترجمة',
                    uploadForMerge1: 'ارفع الصورة الأولى',
                    uploadForMerge2: 'ارفع الصورة الثانية',
                    mergePlaceholder: 'وصف اختياري: ادمج الصورتين مع التركيز على...',
                    mergeBtn: 'دمج الصورتين',
                    downloadTranslation: 'تنزيل الترجمة (الدفع مطلوب)',
                    imagePreviewPlaceholder: 'معاينة الصورة',
                    loaderText: 'الذكاء الاصطناعي يقوم بإنشاء المحتوى الخاص بك... قد يستغرق هذا بعض الوقت.',
                    generatedImageAlt: 'صورة من إنشاء الذكاء الاصطناعي',
                    paymentSuccess: 'تم الدفع بنجاح! يمكنك الآن تنزيل ملفك.',
                    paymentInstructionText: 'لفتح رابط التنزيل، يرجى إتمام عملية الدفع بقيمة 1.00 دولار أدناه.',
                    downloadBtnImage: 'تنزيل الصورة',
                    downloadBtnZip: 'تنزيل ملف ZIP',
                    errorTitleDefault: 'فشلت العملية!',
                    errorInputTitle: 'خطأ في الإدخال',
                    errorInputText: 'الرجاء إدخال وصف نصي لإنشاء الصورة.',
                    errorInputFaceSwap: 'الرجاء رفع كلتا الصورتين لإتمام عملية التركيب.',
                    errorInputEdit: 'الرجاء رفع صورة وتقديم تعليمات التعديل.',
                    errorInputTranslate: 'الرجاء إدخال نص للترجمة.',
                    errorInputMerge: 'الرجاء رفع كلتا الصورتين لدمجهما.',
                    errorPaymentTitle: 'الدفع مطلوب',
                    errorPaymentText: 'يرجى إتمام عملية الدفع لتفعيل رابط التنزيل.',
                    errorApiLimit: 'لقد وصلت إلى حد الطلبات. يرجى المحاولة مرة أخرى لاحقًا.',
                    errorApiGeneric: 'حدث خطأ: {message}',
                    errorNoImage: 'لم يتم استلام بيانات صورة صالحة من الواجهة البرمجية.',
                    errorNoText: 'لم يتم استلام نص صالح من الواجهة البرمجية. قد يكون الرد محجوباً.',
                    errorApiKey: 'مفتاح API مفقود أو غير صالح. الرجاء التحقق من المفتاح في الشيفرة البرمجية.',
                    errorScreenshotDisabled: "لقطات الشاشة معطلة لهذا المحتوى.",
                    copyright: `حقوق الطبع والنشر © ${new Date().getFullYear()} Creative Vision AI. جميع الحقوق محفوظة.`,
                }
            };

            let currentLang = localStorage.getItem('language') || 'ar';
            let currentDownloadData = { type: null, content: null, title: 'content' };
            
            const langBtnEn = document.getElementById('lang-btn-en');
            const langBtnAr = document.getElementById('lang-btn-ar');

            const setLanguage = (lang) => {
                currentLang = lang;
                localStorage.setItem('language', lang);
                
                const translation = translations[lang];
                document.documentElement.lang = lang;
                document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
                document.body.style.fontFamily = lang === 'ar' ? "'Tajawal', sans-serif" : "'Inter', sans-serif";

                document.querySelectorAll('[data-key]').forEach(element => {
                    const key = element.getAttribute('data-key');
                    if (translation[key]) {
                        element.textContent = translation[key];
                    }
                });

                document.querySelectorAll('[data-key-placeholder]').forEach(element => {
                    const key = element.getAttribute('data-key-placeholder');
                    if (translation[key]) {
                        element.placeholder = translation[key];
                    }
                });

                document.querySelectorAll('[data-key-title]').forEach(element => {
                    const key = element.getAttribute('data-key-title');
                    if (translation[key]) {
                        element.title = translation[key];
                    }
                });
                
                document.getElementById('generated-image').alt = translation.generatedImageAlt;

                langBtnEn.classList.toggle('lang-active', lang === 'en');
                langBtnAr.classList.toggle('lang-active', lang === 'ar');

                // Update UI texts if payment section is visible
                if (!paymentSection.classList.contains('hidden')) {
                     resetPaymentUI();
                }
            };

            langBtnEn.addEventListener('click', () => setLanguage('en'));
            langBtnAr.addEventListener('click', () => setLanguage('ar'));
            
            // --- Element Selection ---
            const mainContentWrapper = document.getElementById('main-content-wrapper');
            const tabs = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            const textPrompt = document.getElementById('text-prompt');
            const generateBtnText = document.getElementById('generate-btn-text');
            
            // Translation elements
            const generateBtnTranslate = document.getElementById('generate-btn-translate');
            const translateInput = document.getElementById('translate-input');
            const sourceLang = document.getElementById('source-lang');
            const targetLang = document.getElementById('target-lang');
            const downloadTranslationBtn = document.getElementById('download-translation-btn');

            const resultSection = document.getElementById('result-section');
            const loader = document.getElementById('loader');
            const imageResultContainer = document.getElementById('image-result-container');
            const textResultContainer = document.getElementById('text-result-container');
            const articleContent = document.getElementById('article-content');
            const generatedImage = document.getElementById('generated-image');

            const paymentSection = document.getElementById('payment-section');
            const paymentMessage = document.getElementById('payment-message');
            const paymentInstruction = document.getElementById('payment-instruction');
            const paypalButtonContainer = document.getElementById('paypal-button-container');
            const downloadBtn = document.getElementById('download-btn');
            
            const errorBox = document.getElementById('error-message-box');
            const errorText = document.getElementById('error-text');
            const errorTitle = document.getElementById('error-title');
            
            // AI Edit elements
            const editImageUpload = document.getElementById('edit-image-upload');
            const editImagePreviewContainer = document.getElementById('edit-image-preview-container');
            const editImagePlaceholder = document.getElementById('edit-image-placeholder');
            const editImagePreview = document.getElementById('edit-image-preview');
            const editPrompt = document.getElementById('edit-prompt');
            const generateBtnAiEdit = document.getElementById('generate-btn-aiedit');
            const cancelPreviewBtn = document.getElementById('cancel-preview-btn');
            let uploadedEditFile = null;

            // AI Merge elements
            const mergeImageUpload1 = document.getElementById('merge-image-upload-1');
            const mergeImagePlaceholder1 = document.getElementById('merge-image-placeholder-1');
            const mergeImagePreview1 = document.getElementById('merge-image-preview-1');
            const cancelPreviewBtnMerge1 = document.getElementById('cancel-preview-btn-merge-1');
            const mergeImageUpload2 = document.getElementById('merge-image-upload-2');
            const mergeImagePlaceholder2 = document.getElementById('merge-image-placeholder-2');
            const mergeImagePreview2 = document.getElementById('merge-image-preview-2');
            const cancelPreviewBtnMerge2 = document.getElementById('cancel-preview-btn-merge-2');
            const mergePrompt = document.getElementById('merge-prompt');
            const generateBtnMerge = document.getElementById('generate-btn-merge');
            let uploadedMergeFile1 = null;
            let uploadedMergeFile2 = null;

            // AI Face Swap elements
            const faceswapImageUploadSource = document.getElementById('faceswap-image-upload-source');
            const faceswapImagePlaceholderSource = document.getElementById('faceswap-image-placeholder-source');
            const faceswapImagePreviewSource = document.getElementById('faceswap-image-preview-source');
            const cancelPreviewBtnFaceSwapSource = document.getElementById('cancel-preview-btn-faceswap-source');
            const faceswapImageUploadTarget = document.getElementById('faceswap-image-upload-target');
            const faceswapImagePlaceholderTarget = document.getElementById('faceswap-image-placeholder-target');
            const faceswapImagePreviewTarget = document.getElementById('faceswap-image-preview-target');
            const cancelPreviewBtnFaceSwapTarget = document.getElementById('cancel-preview-btn-faceswap-target');
            const generateBtnFaceSwap = document.getElementById('generate-btn-faceswap');
            let uploadedFaceSwapSource = null;
            let uploadedFaceSwapTarget = null;


            // Result cancel buttons
            const cancelGenerationBtn = document.getElementById('cancel-generation-btn');
            const cancelArticleBtn = document.getElementById('cancel-article-btn');
            
            // --- Screenshot and Copy Protection ---
            if(mainContentWrapper) {
                mainContentWrapper.classList.add('no-screenshot');
            }
            document.addEventListener('contextmenu', (e) => e.preventDefault());
            document.addEventListener('keyup', (e) => {
                if (e.key === 'PrintScreen') {
                    navigator.clipboard.writeText('');
                    showError("errorTitleDefault", "errorScreenshotDisabled");
                }
            });
            
            const checkApiKey = () => {
                if (apiKey === "PASTE_YOUR_GOOGLE_AI_API_KEY_HERE" || !apiKey) {
                    showError("errorInputTitle", "errorApiKey");
                    return false;
                }
                return true;
            };
            
            // --- Tab Switching Logic ---
            tabs.forEach(clickedTab => {
                clickedTab.addEventListener('click', () => {
                    tabs.forEach(tab => {
                        const isClicked = tab === clickedTab;
                        tab.classList.toggle('tab-active', isClicked);
                        tab.classList.toggle('border-transparent', !isClicked);
                        tab.classList.toggle('text-gray-400', !isClicked);
                        tab.classList.toggle('hover:text-gray-200', !isClicked);
                        tab.classList.toggle('hover:border-gray-500', !isClicked);
                        const contentId = `tab-content-${tab.id.split('-')[1]}`;
                        const content = document.getElementById(contentId);
                        if (content) {
                            content.classList.toggle('hidden', !isClicked);
                        }
                    });
                });
            });


            // --- UI Helper Functions ---
            const showLoader = (isLoading) => {
                 const allGenerateBtns = [generateBtnText, generateBtnFaceSwap, generateBtnAiEdit, generateBtnTranslate, generateBtnMerge];
                if (isLoading) {
                    resultSection.classList.remove('hidden');
                    loader.classList.remove('hidden');
                    imageResultContainer.classList.add('hidden');
                    textResultContainer.classList.add('hidden');
                    paymentSection.classList.add('hidden');
                    allGenerateBtns.forEach(btn => btn.disabled = true);
                } else {
                    loader.classList.add('hidden');
                    generateBtnText.disabled = false;
                    generateBtnTranslate.disabled = false;
                    generateBtnAiEdit.disabled = !uploadedEditFile;
                    generateBtnMerge.disabled = !(uploadedMergeFile1 && uploadedMergeFile2);
                    generateBtnFaceSwap.disabled = !(uploadedFaceSwapSource && uploadedFaceSwapTarget);
                }
            };
            
            const showError = (titleKey, messageKey, replacements = {}) => {
                const translation = translations[currentLang];
                errorTitle.textContent = translation[titleKey] || translation['errorTitleDefault'];
                let message = translation[messageKey] || messageKey;
                for (const key in replacements) {
                    message = message.replace(`{${key}}`, replacements[key]);
                }
                errorText.textContent = message;
                errorBox.style.display = 'flex';
                setTimeout(() => { errorBox.style.display = 'none'; }, 6000);
            };

            const resetPaymentUI = () => {
                const translation = translations[currentLang];
                const downloadBtnSpan = downloadBtn.querySelector('span');
                
                paymentMessage.classList.add('hidden');
                paypalButtonContainer.classList.remove('hidden');
                paymentInstruction.classList.remove('hidden');

                if (currentDownloadData.type === 'article' || currentDownloadData.type === 'translation') {
                    if(downloadBtnSpan) downloadBtnSpan.textContent = translation.downloadBtnZip;
                } else {
                    if(downloadBtnSpan) downloadBtnSpan.textContent = translation.downloadBtnImage;
                }
                
                downloadBtn.classList.add('opacity-50', 'cursor-not-allowed');
                
                paypalButtonContainer.innerHTML = '';
                if (window.paypal) {
                    try {
                        paypal.Buttons({
                            createOrder: function(data, actions) {
                                return actions.order.create({
                                    purchase_units: [{
                                        amount: { value: '1.00', currency_code: 'USD' }
                                    }],
                                    application_context: {
                                        shipping_preference: 'NO_SHIPPING'
                                    }
                                });
                            },
                            onApprove: function(data, actions) {
                                return actions.order.capture().then(function(details) {
                                    paymentMessage.classList.remove('hidden');
                                    paypalButtonContainer.classList.add('hidden');
                                    paymentInstruction.classList.add('hidden');
                                    downloadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                                });
                            },
                            onError: function (err) {
                                console.error('PayPal Error:', err);
                                showError("errorTitleDefault", "An error occurred with the payment process. Please try again.");
                            }
                        }).render('#paypal-button-container');
                    } catch (err) {
                        console.error("Error rendering PayPal buttons:", err);
                        showError("errorTitleDefault", "Could not display payment options. Please refresh.");
                    }
                } else {
                     showError("errorTitleDefault", "Failed to load payment gateway. Please refresh the page.");
                }
            };

            const showPaymentUI = (type) => {
                paymentSection.classList.remove('hidden');
                downloadBtn.classList.remove('hidden'); 
                
                if (type === 'article' || type === 'translation') {
                    downloadBtn.download = 'ai_content.zip';
                } else {
                    downloadBtn.download = 'ai_generated_image.png';
                }
                resetPaymentUI();
            };

            const fileToBase64 = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });

            // --- Real AI Image Generation (Text-to-Image) ---
            const generateAIImage = async (prompt) => {
                if (!checkApiKey()) return;
                if (!prompt.trim()) return showError("errorInputTitle", "errorInputText");
                showLoader(true);
                downloadTranslationBtn.classList.add('hidden');
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                const payload = { instances: [{ prompt }], parameters: { "sampleCount": 1 } };

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error?.message || `HTTP error! status: ${response.status}`);
                    
                    if (result.predictions && result.predictions[0]?.bytesBase64Encoded) {
                        const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                        currentDownloadData = { type: 'image', content: imageUrl, title: prompt.substring(0, 20) };
                        generatedImage.src = imageUrl;
                        textResultContainer.classList.add('hidden');
                        imageResultContainer.classList.remove('hidden');
                        showPaymentUI('image');
                    } else {
                        console.error("API Response without image:", result);
                        throw new Error("The AI could not generate an image for this prompt. It might be due to safety filters. Please try a different prompt.");
                    }
                } catch (error) {
                    console.error("AI Generation Error:", error);
                    showError("errorTitleDefault", "errorApiGeneric", { message: error.message });
                    resultSection.classList.add('hidden');
                } finally {
                    showLoader(false);
                }
            };

            generateBtnText.addEventListener('click', () => generateAIImage(textPrompt.value));

            // --- AI Text Translation ---
            const translateText = async (text, source, target) => {
                if (!checkApiKey()) return;
                if (!text.trim()) return showError("errorInputTitle", "errorInputTranslate");
                showLoader(true);
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const systemPrompt = `You are an expert multilingual translator. Translate the user's text accurately from the source language to the target language. Provide only the translated text as the output, with no additional commentary or explanations.`;
                const userPrompt = `Translate the following text from ${source} to ${target}:\n\n"${text}"`;
                const payload = { contents: [{ parts: [{ text: userPrompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error?.message || `HTTP error! status: ${response.status}`);
                    
                    const translatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (translatedText) {
                        currentDownloadData = { type: 'translation', content: translatedText, title: 'translation' };
                        articleContent.textContent = translatedText;
                        
                        const rtlLangs = ['Arabic', 'Hebrew', 'Aramaic', 'Syriac'];
                        if (rtlLangs.includes(target)) {
                            articleContent.parentElement.dir = 'rtl';
                            articleContent.style.textAlign = 'right';
                        } else {
                            articleContent.parentElement.dir = 'ltr';
                            articleContent.style.textAlign = 'left';
                        }

                        imageResultContainer.classList.add('hidden');
                        textResultContainer.classList.remove('hidden');
                        downloadTranslationBtn.classList.remove('hidden');
                        paymentSection.classList.add('hidden');
                    } else {
                        throw new Error(translations[currentLang].errorNoText);
                    }
                } catch (error) {
                    console.error("AI Translation Error:", error);
                    showError("errorTitleDefault", "errorApiGeneric", { message: error.message });
                    resultSection.classList.add('hidden');
                } finally {
                    showLoader(false);
                }
            };
            generateBtnTranslate.addEventListener('click', () => translateText(translateInput.value, sourceLang.value, targetLang.value));
            
            downloadTranslationBtn.addEventListener('click', () => {
                showPaymentUI('translation');
            });

            // --- Image Download Preparation (Protection Removed) ---
            const prepareImageForDownload = (imageUrl) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        resolve(canvas.toDataURL('image/png'));
                    };
                    img.onerror = () => {
                        showError("errorTitleDefault", "Failed to load image for download.");
                        resolve(null);
                    }
                    img.src = imageUrl;
                });
            };


            // --- Real AI Image Editing (Image-to-Image) ---
            const editAIImage = async (file, prompt) => {
                if (!checkApiKey()) return;
                if (!file || !prompt.trim()) return showError("errorInputTitle", "errorInputEdit");
                showLoader(true);
                downloadTranslationBtn.classList.add('hidden');
                try {
                    const base64Data = await fileToBase64(file);
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                    const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: file.type, data: base64Data } }] }], generationConfig: { responseModalities: ['IMAGE'] } };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error?.message || `HTTP error! status: ${response.status}`);
                    
                    const candidate = result.candidates?.[0];
                    if (!candidate) throw new Error("The AI did not return a valid response.");
                    
                    const blockReason = candidate.finishReason === 'SAFETY' || result?.promptFeedback?.blockReason;
                    if (blockReason) throw new Error(`Request blocked due to: ${result?.promptFeedback?.blockReason || 'Safety Filters'}.`);

                    const generatedPart = candidate.content?.parts?.find(p => p.inlineData);
                    if (generatedPart?.inlineData?.data) {
                        const imageUrl = `data:${generatedPart.inlineData.mimeType};base64,${generatedPart.inlineData.data}`;
                        currentDownloadData = { type: 'image', content: imageUrl, title: 'edited-image' };
                        generatedImage.src = imageUrl;
                        textResultContainer.classList.add('hidden');
                        imageResultContainer.classList.remove('hidden');
                        showPaymentUI('image');
                    } else {
                         let detailedError = "The AI could not edit the image. This might be due to safety filters. Please try different instructions.";
                         throw new Error(detailedError);
                    }
                } catch (error) {
                    console.error("AI Edit Error:", error);
                    showError("errorTitleDefault", "errorApiGeneric", { message: error.message });
                    resultSection.classList.add('hidden');
                } finally {
                    showLoader(false);
                }
            };
            generateBtnAiEdit.addEventListener('click', () => editAIImage(uploadedEditFile, editPrompt.value));
            
            // --- Real AI Image Merging (Image-to-Image) ---
            const mergeAIImages = async (file1, file2, prompt) => {
                if (!checkApiKey()) return;
                if (!file1 || !file2) return showError("errorInputTitle", "errorInputMerge");
                showLoader(true);
                downloadTranslationBtn.classList.add('hidden');
                try {
                    const base64Data1 = await fileToBase64(file1);
                    const base64Data2 = await fileToBase64(file2);

                    const userPrompt = prompt.trim() || "Merge these two images together creatively.";

                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                    const payload = { 
                        contents: [{ 
                            parts: [
                                { text: userPrompt }, 
                                { inlineData: { mimeType: file1.type, data: base64Data1 } },
                                { inlineData: { mimeType: file2.type, data: base64Data2 } }
                            ] 
                        }], 
                        generationConfig: { responseModalities: ['IMAGE'] } 
                    };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error?.message || `HTTP error! status: ${response.status}`);
                    
                    const candidate = result.candidates?.[0];
                    if (!candidate) throw new Error("The AI did not return a valid response.");
                    
                    const blockReason = candidate.finishReason === 'SAFETY' || result?.promptFeedback?.blockReason;
                    if (blockReason) throw new Error(`Request blocked due to: ${result?.promptFeedback?.blockReason || 'Safety Filters'}.`);

                    const generatedPart = candidate.content?.parts?.find(p => p.inlineData);
                    if (generatedPart?.inlineData?.data) {
                        const imageUrl = `data:${generatedPart.inlineData.mimeType};base64,${generatedPart.inlineData.data}`;
                        currentDownloadData = { type: 'image', content: imageUrl, title: 'merged-image' };
                        generatedImage.src = imageUrl;
                        textResultContainer.classList.add('hidden');
                        imageResultContainer.classList.remove('hidden');
                        showPaymentUI('image');
                    } else {
                         let detailedError = "The AI could not merge the images. This might be due to safety filters. Please try different images or instructions.";
                         throw new Error(detailedError);
                    }
                } catch (error) {
                    console.error("AI Merge Error:", error);
                    showError("errorTitleDefault", "errorApiGeneric", { message: error.message });
                    resultSection.classList.add('hidden');
                } finally {
                    showLoader(false);
                }
            };
            generateBtnMerge.addEventListener('click', () => mergeAIImages(uploadedMergeFile1, uploadedMergeFile2, mergePrompt.value));

            // --- Real AI Face Swap ---
            const generateFaceSwap = async (fileSource, fileTarget) => {
                if (!checkApiKey()) return;
                if (!fileSource || !fileTarget) return showError("errorInputTitle", "errorInputFaceSwap");
                showLoader(true);
                downloadTranslationBtn.classList.add('hidden');
                try {
                    const base64DataSource = await fileToBase64(fileSource);
                    const base64DataTarget = await fileToBase64(fileTarget);

                    const userPrompt = `
Act as a professional digital artist specializing in hyper-realistic photo manipulation. Your task is to perform a flawless face swap.

**Source Image (First Image):** This image contains the face to be extracted.
**Target Image (Second Image):** This image contains the body and scene where the new face will be placed.

**Critical Instructions for a Perfect Swap:**
1.  **Precise Extraction:** Isolate only the facial features (eyes, nose, mouth, cheeks, chin) from the Source Image. Do not include hair or neck if possible.
2.  **Proportional Scaling & Alignment:** Carefully scale and rotate the extracted face to perfectly match the proportions and head angle of the person in the Target Image.
3.  **Seamless Blending:** The connection point between the swapped face and the target's neck/jawline must be absolutely seamless. There should be no visible edges or lines.
4.  **Skin Tone & Texture Matching:** Meticulously adjust the color balance, hue, saturation, and brightness of the source face to match the skin tone of the target body. Replicate the skin texture (pores, subtle imperfections) of the target image onto the new face.
5.  **Lighting & Shadow Harmonization:** Analyze the lighting direction, intensity, and color in the Target Image. Re-light the swapped face so that all shadows and highlights on it are consistent with the surrounding environment. The face must look like it was naturally part of the original photo.
6.  **Maintain Expression:** Preserve the original facial expression from the Source Image.

The final output must be a single, photorealistic image that looks completely natural and unedited.`;

                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                    const payload = { 
                        contents: [{ 
                            parts: [
                                { text: userPrompt }, 
                                { inlineData: { mimeType: fileSource.type, data: base64DataSource } },
                                { inlineData: { mimeType: fileTarget.type, data: base64DataTarget } }
                            ] 
                        }], 
                        generationConfig: { responseModalities: ['IMAGE'] } 
                    };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error?.message || `HTTP error! status: ${response.status}`);
                    
                    const candidate = result.candidates?.[0];
                    if (!candidate) throw new Error("The AI did not return a valid response.");
                    
                    const blockReason = candidate.finishReason === 'SAFETY' || result?.promptFeedback?.blockReason;
                    if (blockReason) throw new Error(`Request blocked due to: ${result?.promptFeedback?.blockReason || 'Safety Filters'}.`);

                    const generatedPart = candidate.content?.parts?.find(p => p.inlineData);
                    if (generatedPart?.inlineData?.data) {
                        const imageUrl = `data:${generatedPart.inlineData.mimeType};base64,${generatedPart.inlineData.data}`;
                        currentDownloadData = { type: 'image', content: imageUrl, title: 'face-swap-result' };
                        generatedImage.src = imageUrl;
                        textResultContainer.classList.add('hidden');
                        imageResultContainer.classList.remove('hidden');
                        showPaymentUI('image');
                    } else {
                         let detailedError = "The AI could not perform the face swap. This might be due to safety filters. Please try different images.";
                         throw new Error(detailedError);
                    }
                } catch (error) {
                    console.error("AI Face Swap Error:", error);
                    showError("errorTitleDefault", "errorApiGeneric", { message: error.message });
                    resultSection.classList.add('hidden');
                } finally {
                    showLoader(false);
                }
            };
            generateBtnFaceSwap.addEventListener('click', () => generateFaceSwap(uploadedFaceSwapSource, uploadedFaceSwapTarget));


            // --- Result Cancellation Logic ---
            const cancelResult = () => {
                resultSection.classList.add('hidden');
                downloadTranslationBtn.classList.add('hidden');
                currentDownloadData = { type: null, content: null, title: 'content' };
            };
            cancelGenerationBtn.addEventListener('click', cancelResult);
            cancelArticleBtn.addEventListener('click', cancelResult);

             // --- Download Logic ---
            const downloadTextAsZip = async (title, content) => {
                const doc = new jsPDF();
                const zip = new JSZip();

                 doc.setFont('Helvetica'); 
                 doc.setLanguage('ar');
                 
                 const lines = doc.splitTextToSize(content, 180);
                 const pageHeight = doc.internal.pageSize.height;
                 const pageWidth = doc.internal.pageSize.width;
                 let y = 15;

                 for(let i = 0; i < lines.length; i++) {
                    if (y > pageHeight - 20) {
                        doc.addPage();
                        y = 15;
                    }
                    doc.text(lines[i], pageWidth - 15, y, { align: 'right' });
                    y += 7;
                 }
                
                const pdfBlob = doc.output('blob');
                zip.file(`${title.replace(/ /g, "_")}.pdf`, pdfBlob);
                
                const zipBlob = await zip.generateAsync({ type: "blob" });
                const url = URL.createObjectURL(zipBlob);
                const tempLink = document.createElement('a');
                tempLink.href = url;
                tempLink.download = 'ai_content.zip';
                tempLink.click();
                URL.revokeObjectURL(url);
            };

            downloadBtn.addEventListener('click', async (event) => {
                event.preventDefault();
                if (downloadBtn.classList.contains('cursor-not-allowed')) {
                    showError("errorPaymentTitle", "errorPaymentText");
                    return;
                }
                
                if (currentDownloadData.type === 'translation') {
                    await downloadTextAsZip(currentDownloadData.title, currentDownloadData.content);
                } else if (currentDownloadData.type.includes('image')){
                    const imageUrl = await prepareImageForDownload(currentDownloadData.content);
                    if (imageUrl) {
                        const tempLink = document.createElement('a');
                        tempLink.href = imageUrl;
                        tempLink.download = 'ai_image.png';
                        tempLink.click();
                    }
                }
            });
            
            // --- Image Upload & Preview Reset Logic ---
            const resetEditPreview = () => {
                uploadedEditFile = null;
                editImageUpload.value = null; 
                editImagePreview.src = '#';
                editImagePreview.classList.add('hidden');
                cancelPreviewBtn.classList.add('hidden');
                editImagePlaceholder.classList.remove('hidden');
                editPrompt.disabled = true;
                editPrompt.value = '';
                generateBtnAiEdit.disabled = true;
            };
            cancelPreviewBtn.addEventListener('click', resetEditPreview);
            
            const resetMergePreview1 = () => {
                uploadedMergeFile1 = null;
                mergeImageUpload1.value = null;
                mergeImagePreview1.src = '#';
                mergeImagePreview1.classList.add('hidden');
                cancelPreviewBtnMerge1.classList.add('hidden');
                mergeImagePlaceholder1.classList.remove('hidden');
                generateBtnMerge.disabled = true;
            };
            cancelPreviewBtnMerge1.addEventListener('click', resetMergePreview1);
            
            const resetMergePreview2 = () => {
                uploadedMergeFile2 = null;
                mergeImageUpload2.value = null;
                mergeImagePreview2.src = '#';
                mergeImagePreview2.classList.add('hidden');
                cancelPreviewBtnMerge2.classList.add('hidden');
                mergeImagePlaceholder2.classList.remove('hidden');
                generateBtnMerge.disabled = true;
            };
            cancelPreviewBtnMerge2.addEventListener('click', resetMergePreview2);
            
            const resetFaceSwapPreviewSource = () => {
                uploadedFaceSwapSource = null;
                faceswapImageUploadSource.value = null;
                faceswapImagePreviewSource.src = '#';
                faceswapImagePreviewSource.classList.add('hidden');
                cancelPreviewBtnFaceSwapSource.classList.add('hidden');
                faceswapImagePlaceholderSource.classList.remove('hidden');
                generateBtnFaceSwap.disabled = true;
            };
            cancelPreviewBtnFaceSwapSource.addEventListener('click', resetFaceSwapPreviewSource);

            const resetFaceSwapPreviewTarget = () => {
                uploadedFaceSwapTarget = null;
                faceswapImageUploadTarget.value = null;
                faceswapImagePreviewTarget.src = '#';
                faceswapImagePreviewTarget.classList.add('hidden');
                cancelPreviewBtnFaceSwapTarget.classList.add('hidden');
                faceswapImagePlaceholderTarget.classList.remove('hidden');
                generateBtnFaceSwap.disabled = true;
            };
            cancelPreviewBtnFaceSwapTarget.addEventListener('click', resetFaceSwapPreviewTarget);


            // --- Image Upload Handlers ---
            editImageUpload.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    uploadedEditFile = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        editImagePlaceholder.classList.add('hidden');
                        editImagePreview.src = event.target.result;
                        editImagePreview.classList.remove('hidden');
                        cancelPreviewBtn.classList.remove('hidden');
                        editPrompt.disabled = false;
                        generateBtnAiEdit.disabled = false;
                    };
                    reader.readAsDataURL(uploadedEditFile);
                } else {
                   resetEditPreview();
                }
            });

             const handleMergeImageUpload = (e, fileNumber) => {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        if (fileNumber === 1) {
                            uploadedMergeFile1 = file;
                            mergeImagePlaceholder1.classList.add('hidden');
                            mergeImagePreview1.src = event.target.result;
                            mergeImagePreview1.classList.remove('hidden');
                            cancelPreviewBtnMerge1.classList.remove('hidden');
                        } else {
                            uploadedMergeFile2 = file;
                            mergeImagePlaceholder2.classList.add('hidden');
                            mergeImagePreview2.src = event.target.result;
                            mergeImagePreview2.classList.remove('hidden');
                            cancelPreviewBtnMerge2.classList.remove('hidden');
                        }
                        if (uploadedMergeFile1 && uploadedMergeFile2) {
                            generateBtnMerge.disabled = false;
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };

            mergeImageUpload1.addEventListener('change', (e) => handleMergeImageUpload(e, 1));
            mergeImageUpload2.addEventListener('change', (e) => handleMergeImageUpload(e, 2));

             const handleFaceSwapImageUpload = (e, type) => {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        if (type === 'source') {
                            uploadedFaceSwapSource = file;
                            faceswapImagePlaceholderSource.classList.add('hidden');
                            faceswapImagePreviewSource.src = event.target.result;
                            faceswapImagePreviewSource.classList.remove('hidden');
                            cancelPreviewBtnFaceSwapSource.classList.remove('hidden');
                        } else {
                            uploadedFaceSwapTarget = file;
                            faceswapImagePlaceholderTarget.classList.add('hidden');
                            faceswapImagePreviewTarget.src = event.target.result;
                            faceswapImagePreviewTarget.classList.remove('hidden');
                            cancelPreviewBtnFaceSwapTarget.classList.remove('hidden');
                        }
                        if (uploadedFaceSwapSource && uploadedFaceSwapTarget) {
                            generateBtnFaceSwap.disabled = false;
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };
            faceswapImageUploadSource.addEventListener('change', (e) => handleFaceSwapImageUpload(e, 'source'));
            faceswapImageUploadTarget.addEventListener('change', (e) => handleFaceSwapImageUpload(e, 'target'));


            // --- Initial Load ---
            setLanguage(currentLang);
        });
    </script>

</body>
</html>





